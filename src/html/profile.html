<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="color-scheme" content="light dark" />
        <title>SliDesk.link | Profile</title>
        <link rel="icon" href="/public/slidesk.svg" type="image/svg+xml" />
        <link rel="icon" href="/public/slidesk.ico" type="image/x-icon" />
        <link
            rel="icon"
            href="/public/slidesk-32x32.png"
            type="image/png"
            sizes="32x32"
        />
        <link
            rel="apple-touch-icon"
            href="/public/slidesk-180x180.png"
            type="image/png"
            sizes="180x180"
        />
    </head>
    <body>
        <header>
            <nav class="container">
                <ul>
                    <li>
                        <a href="/" id="backhome">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                xml:space="preserve"
                                viewBox="0 0 256 256"
                            >
                                <defs>
                                    <style>
                                        .color {
                                            stroke: black;
                                            color-scheme: light dark;
                                        }
                                        @media (prefers-color-scheme: dark) {
                                            .color {
                                                stroke: white;
                                            }
                                        }
                                    </style>
                                </defs>
                                <circle
                                    cx="149.95"
                                    cy="72.23"
                                    r="36.22"
                                    fill="none"
                                    stroke="#999"
                                    stroke-width="14"
                                />
                                <ellipse
                                    cx="128"
                                    cy="163.51"
                                    fill="none"
                                    stroke="#999"
                                    stroke-width="14"
                                    rx="88.25"
                                    ry="56.48"
                                />
                                <path
                                    fill="none"
                                    class="color"
                                    stroke-width="14"
                                    d="M128 107.03c48.74 0 88.25 25.29 88.25 56.48s-39.51 56.48-88.25 56.48c-33.72 0-63.02-12.1-77.88-29.89"
                                />
                                <path
                                    fill="none"
                                    class="color"
                                    stroke-linecap="round"
                                    stroke-width="14"
                                    d="M144.11 107.98c-41.53-4.76-66.08 8.98-68.24 18.96-3.77 17.45 18.76 23.4 37.85 30.11 26.5 9.31 28.48 26.57 20.95 39.79-11.45 20.11-65.69 20.6-87.92-11.22"
                                />
                                <ellipse
                                    cx="155.7"
                                    cy="66.47"
                                    fill="#999"
                                    stroke="#999"
                                    stroke-miterlimit="10"
                                    rx="5.29"
                                    ry="5.76"
                                />
                                <path
                                    fill="#999"
                                    stroke="#999"
                                    stroke-miterlimit="10"
                                    d="M186.17 69.62s15.38-1.47 17.28 1.35c1.35 6.92-12.66 13.48-18.25 13.48"
                                />
                            </svg>
                            <h1>SliDesk<span>.link</span></h1>
                        </a>
                    </li>
                </ul>
                <ul>
                    <li><a href="#" id="gotomypage">My page</a></li>
                    <li><a href="/exit">Logout</a></li>
                </ul>
            </nav>
        </header>
        <main class="container">
            <article>
                <form method="post">
                    <fieldset>
                        <label>
                            Name
                            <input
                                name="name"
                                placeholder="Your name"
                                autocomplete="name"
                                aria-label="your name"
                                required
                            />
                        </label>
                    </fieldset>
                    <fieldset>
                        <label>
                            Slug
                            <input
                                name="slug"
                                placeholder="Your slug/login"
                                autocomplete="nickname"
                                aria-label="your nickname"
                                required
                                pattern="[A-z0-9\-_]+"
                            />
                        </label>
                    </fieldset>
                    <fieldset>
                        <label>
                            AvatarUrl
                            <input
                                name="avatarUrl"
                                placeholder="Your avatar url"
                                autocomplete="off"
                                aria-label="url of your avatar"
                            />
                        </label>
                    </fieldset>
                    <fieldset>
                        <label>
                            Url
                            <input
                                name="url"
                                placeholder="Your url"
                                autocomplete="off"
                                aria-label="url of your personal site"
                            />
                        </label>
                    </fieldset>
                    <fieldset>
                        <label>
                            Bio (markdown)
                            <textarea
                                name="bio"
                                placeholder="Write a professional short bio..."
                                aria-label="Professional short bio"
                            ></textarea>
                        </label>
                    </fieldset>
                    <input type="submit" />
                </form>
            </article>
            <h2>Hosted</h2>
            <div id="hosted"></div>
            <h2>Presentations</h2>
            <div id="presentations"></div>
        </main>
        <footer>
            <nav class="container">
                <ul>
                    <li>slidesk<span>.link</span></li>
                </ul>
                <ul>
                    <li>
                        <a
                            href="https://slidesk.github.io/slidesk-doc/"
                            target="_blank"
                            rel="noopener"
                            >Documentation</a
                        >
                    </li>
                    <li>
                        <a
                            href="https://github.com/slidesk/slidesk.link"
                            target="_blank"
                            rel="noopener"
                            >Source code</a
                        >
                    </li>
                    <li><a href="/mentions">Legal</a></li>
                </ul>
            </nav>
        </footer>
        <script>
            const autosize = () => {
                const resize = ($text) => {
                    $text.style.height = "auto";
                    $text.style.height = `${$text.scrollHeight}px`;
                };
                const $text = document.querySelector("textarea");
                $text.setAttribute("rows", 1);
                resize($text);
                $text.addEventListener("input", () => resize($text));
            };
            autosize();
            fetch(`/profile/data?${Date.now()}`)
                .then((response) => response.json())
                .then((data) => {
                    Object.entries(data.form).forEach(([k, v], _) => {
                        document.querySelector(`[name='${k}']`).value = v;
                    });
                    document
                        .querySelector("#gotomypage")
                        .setAttribute("href", `/u/${data.form.slug}`);
                    autosize();
                    if (data.presentations.length) {
                        document.querySelector("#presentations").innerHTML =
                            data.presentations
                                .map(
                                    (p) => `
                                      <article id="p_${p.id}">
                                        <header>${p.title}</header>
                                        <main>
                                          <blockquote>${p.abstract}</blockquote>
                                          <table class="striped">
                                          ${[...p.Session]
                                              .sort(
                                                  (a, b) =>
                                                      Number(a.date) -
                                                      Number(b.date),
                                              )
                                              .map(
                                                  (s) => `
                                              <tr id="s_${s.id}">
                                                <td>${new Date(s.date).toISOString().split("T")[0]}: ${s.location}</td>
                                                <td><button class="secondary" onclick="window.removeSession(${s.id});">Delete Session</button></td>
                                              </tr>
                                          `,
                                              )
                                              .join("")}
                                          </table>
                                        </main>
                                        <footer>
                                          <button class="secondary" onclick="window.removePresentation(${p.id});">Delete Presentation</button>
                                        </footer>
                                      </article>
                                    `,
                                )
                                .join("");
                    } else {
                        document.querySelector("#presentations").innerHTML =
                            "No presentation found";
                    }
                    if (data.hosted.length) {
                        document.querySelector("#hosted").innerHTML = `
                          <table class="striped">
                          ${data.hosted
                              .map(
                                  (h) => `
                            <tr id="h_${h.id}">
                              <td><a href="https://slidesk.link/s/${h.id}/" target="_blank">${h.id}</a></td>
                              <td>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock-icon lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                ${new Date(h.createdAt).toISOString()}
                              </td>
                              <td><button class="secondary" onclick="window.removeHosted('${h.id}');">Delete Hosted</button></td>
                            </tr>
                            `,
                              )
                              .join("")}
                          </table>
                        `;
                    } else {
                        document.querySelector("#hosted").innerHTML =
                            "No hosted found";
                    }
                });

            window.removeSession = (id) => {
                fetch(`/profile/session/${id}`, {
                    method: "DELETE",
                }).then(() => {
                    document.querySelector(`#s_${id}`).remove();
                });
            };

            window.removePresentation = (id) => {
                fetch(`/profile/presentation/${id}`, {
                    method: "DELETE",
                }).then(() => {
                    document.querySelector(`#p_${id}`).remove();
                });
            };

            window.removeHosted = (id) => {
                fetch(`/profile/hosted/${id}`, {
                    method: "DELETE",
                }).then(() => {
                    document.querySelector(`#h_${id}`).remove();
                });
            };
        </script>
    </body>
</html>
